# HTTPS 优化

## 性能损耗

* 产生消耗
  * TLS握手（2RTT）
  * 握手后的加密报文传输（很小）

## 硬件优化

* HTTPS协议是计算密集型，不是I/O密集型
* 应该提升CPU
* 选择支持AES-NI特性的CPU，加速数据加解密过程

## 软件优化

* 软件升级
* Linux：2.x到4.x
* OpenSSL ：1.0.1到1.1.1

## 协议优化

* 用 ECDHE 算法替换 RSA 算法，将握手消息往返减少到 1RTT，选择 x25519 曲线（目前最快）
* TLS升级，从1.2到1.3
  * TLS1.3 把 Hello 和公钥交换两个消息合并成了一个，只需 1 RTT 就能完成 TLS 握手
  * TLS1.3 废除了不支持前向安全的RSA和DH算法

## 证书优化

* 证书传输优化

  * 减少证书大小
  * 服务器证书选择椭圆曲线（ECDSA）证书
* 证书验证优化

  * 客户端验证证书时，使用证书链逐级验证，为了知道证书是否被CA吊销，还需要下载CRL或者OCSP以验证证书有效性
* CRL

  * 证书吊销列表，由CA定期更新
  * 实时性较差
  * 证书多时下载速度慢
* OCSP

  * 在线证书状态协议
  * 向CA发送查询请求、返回证书的有序状态
  * 解决了实时性和列表大的问题
  * 依赖网络和CA服务器状态
* OCSP Staping

  * 服务器向CA周期性查询证书状态，获得一个带有时间戳和签名的响应结果并缓存
  * 客户端发送请求时，服务器将结果告诉客户端

## 会话复用

* Session ID：
  * **客户端和服务器首次 TLS 握手连接后，双方会在内存缓存会话密钥**，并用唯一的 Session ID 来标识
  * Session ID和会话密钥类似于key-value的关系
  * 服务器必须保持每一个客户端的密钥、内存压力大
  * 多台服务器情况下，客户端再次连接时不一定能访问到上次的服务器
* Session Ticket
  * 服务器不再缓存、而是交给客户端
  * 客户端和服务器首次连接时，服务器加密密钥作为Ticket发给客户端，客户端缓存
  * 客户端再次连接服务器时，会发送Ticket
* 都不具备前向安全性
* Pre-shared Key
  * TLS 1.3重连需要0RTT，重连时，客户端会把Ticket和HTTP一同发送给服务端
* 都有重放攻击的危险
