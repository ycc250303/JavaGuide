name: 自动更新日志

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # 允许手动触发

jobs:
  update-log:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # 需要写入权限来提交更改
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 配置 Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: 生成更新日志
        id: generate-log
        run: |
          # 设置起始日期（2026-01-09）
          START_DATE="2026-01-09"
          
          # 如果 update_log.md 不存在，创建它
          if [ ! -f "update_log.md" ]; then
            echo "# 更新日志" > update_log.md
            echo "" >> update_log.md
            echo "> 自动生成，记录 $START_DATE 之后的更新" >> update_log.md
            echo "" >> update_log.md
          fi
          
          # 读取并清理现有的内容（移除 \r）
          EXISTING_CONTENT=$(cat update_log.md | tr -d '\r')
          
          # 提取已记录的提交哈希（7位短哈希）
          RECORDED_HASHES=$(echo "$EXISTING_CONTENT" | grep -oE '`[a-f0-9]{7}`|\[[a-f0-9]{7}\]' | sed 's/[`\[\]]//g' | sort -u || echo "")
          
          # 获取提交记录，过滤掉 CI 自身的提交
          ALL_COMMITS=$(git log --since="$START_DATE" --pretty=format:"%H|%ad|%an|%s" --date=format:"%Y-%m-%d %H:%M:%S" --grep="chore: 自动更新日志" --invert-grep)
          
          if [ -z "$ALL_COMMITS" ]; then
            echo "没有找到需要记录的提交"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 过滤出未记录的提交
          NEW_COMMITS=""
          while IFS='|' read -r hash date author message; do
            SHORT_HASH=$(echo "$hash" | cut -c1-7)
            if ! echo "$RECORDED_HASHES" | grep -q "^$SHORT_HASH$"; then
              NEW_COMMITS="${NEW_COMMITS}${hash}|${date}|${author}|${message}"$'\n'
            fi
          done <<< "$ALL_COMMITS"
          
          if [ -z "$(echo "$NEW_COMMITS" | tr -d ' \n')" ]; then
            echo "所有提交已记录"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 生成新条目文本
          TEMP_NEW=$(mktemp)
          CURRENT_DATE=""
          while IFS='|' read -r hash date author message; do
            [ -z "$hash" ] && continue
            COMMIT_DATE=$(echo "$date" | cut -d' ' -f1)
            SHORT_HASH=$(echo "$hash" | cut -c1-7)
            TIME=$(echo "$date" | cut -d' ' -f2)
            
            if [ "$COMMIT_DATE" != "$CURRENT_DATE" ]; then
              [ -n "$CURRENT_DATE" ] && echo "" >> "$TEMP_NEW"
              echo "## $COMMIT_DATE" >> "$TEMP_NEW"
              echo "" >> "$TEMP_NEW"
              CURRENT_DATE="$COMMIT_DATE"
            fi
            echo "- $TIME - $message [\`$SHORT_HASH\`]" >> "$TEMP_NEW"
          done <<< "$NEW_COMMITS"
          
          # 提取旧内容的 Body（去掉 Header 和第一行日期，如果新内容已经包含了该日期）
          FIRST_NEW_DATE=$(head -n 1 "$TEMP_NEW" | sed 's/## //')
          
          if echo "$EXISTING_CONTENT" | grep -q "^## "; then
            HEADER=$(echo "$EXISTING_CONTENT" | sed -n '1,/^## /p' | sed '$d')
            BODY=$(echo "$EXISTING_CONTENT" | sed -n '/^## /,$p')
            
            # 如果 BODY 的第一个日期标题和 NEW_ENTRIES 的最后一个日期标题相同，则移除 BODY 的标题
            LAST_NEW_DATE_HEADER=$(grep "^## " "$TEMP_NEW" | tail -n 1)
            if [ -n "$LAST_NEW_DATE_HEADER" ] && echo "$BODY" | head -n 1 | grep -q "^$LAST_NEW_DATE_HEADER$"; then
              BODY=$(echo "$BODY" | sed '1,2d') # 移除日期标题和紧随其后的空行
            fi
          else
            HEADER="$EXISTING_CONTENT"
            BODY=""
          fi
          
          # 合并并写入
          {
            echo "$HEADER"
            echo ""
            cat "$TEMP_NEW"
            echo ""
            [ -n "$BODY" ] && echo "$BODY"
          } | sed '/^$/N;/^\n$/D' > update_log.md # 使用 sed 压缩连续空行
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: 提交并推送更新
        if: steps.generate-log.outputs.has_changes == 'true'
        run: |
          git add update_log.md
          git commit -m "chore: 自动更新日志 [skip ci]" || exit 0
          git push || exit 0
